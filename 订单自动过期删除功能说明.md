# 商品订单自动过期删除功能说明

## 功能概述

本功能实现了商品订单的自动过期处理机制，当订单超过设定的过期时间后，系统会自动处理这些过期订单。

## 实现方案

### 1. 核心组件

#### 1.1 定时任务类
- **文件位置**: `src/main/java/org/sc/smartcommunitybackend/task/OrderScheduledTask.java`
- **功能**: 定时检查并处理过期订单

#### 1.2 主要方法

##### deleteExpiredOrders()
- **执行频率**: 每5分钟执行一次
- **Cron表达式**: `0 */5 * * * ?`
- **功能**: 直接从数据库删除过期的待支付订单
- **适用场景**: 不需要保留过期订单历史记录

##### cancelExpiredOrders()
- **执行频率**: 每3分钟执行一次
- **Cron表达式**: `0 */3 * * * ?`
- **功能**: 将过期订单状态更新为"已取消"（status=5）
- **适用场景**: 需要保留订单历史记录用于数据分析

### 2. 订单过期时间设置

#### 2.1 创建订单时设置
在 `UnifiedOrderServiceImpl.createProductOrder()` 方法中：
```java
Date now = new Date();
Date expireTime = new Date(now.getTime() + 30 * 60 * 1000); // 30分钟过期
paymentOrder.setExpireTime(expireTime);
```

#### 2.2 配置文件设置
在 `application.properties` 或 `application-dev.properties` 中添加：
```properties
# 订单过期时间（分钟），默认30分钟
order.expire.minutes=30
```

### 3. 订单状态说明

| 状态码 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | 待支付 | 订单已创建，等待支付 |
| 1 | 支付中 | 正在进行支付处理 |
| 2 | 支付成功 | 支付完成，待取货 |
| 3 | 已完成 | 订单已完成 |
| 4 | 支付失败 | 支付处理失败 |
| 5 | 已取消 | 订单已取消 |
| 6 | 已退款 | 订单已退款 |

### 4. 使用建议

#### 4.1 选择处理策略

**方案一：删除过期订单**
- 优点：节省数据库存储空间，数据更清爽
- 缺点：无法追溯历史订单数据
- 适用：对历史数据要求不高的场景
- 操作：保留 `deleteExpiredOrders()` 方法的 `@Scheduled` 注解

**方案二：取消过期订单**
- 优点：保留完整的订单历史，便于数据分析
- 缺点：占用更多存储空间
- 适用：需要数据分析和用户行为追踪的场景
- 操作：保留 `cancelExpiredOrders()` 方法的 `@Scheduled` 注解

**方案三：组合使用**
- 先取消订单（保留短期历史）
- 定期清理长期未支付的已取消订单
- 适用：平衡数据保留和存储空间的场景

#### 4.2 禁用某个定时任务

如果只想使用其中一种策略，可以注释掉另一个方法上的 `@Scheduled` 注解：

```java
// 注释掉这个注解即可禁用该定时任务
// @Scheduled(cron = "0 */5 * * * ?")
public void deleteExpiredOrders() {
    // ...
}
```

### 5. 监控和维护

#### 5.1 查看日志
定时任务执行时会输出详细日志：
```
开始执行过期订单删除任务...
发现 5 个过期订单，准备删除
删除过期订单成功 - 订单号: PO20260107001, 订单ID: 123, 创建时间: ..., 过期时间: ...
过期订单删除任务完成，成功删除 5 个订单
```

#### 5.2 数据库查询
使用提供的 SQL 脚本 `order_expiration_management.sql` 进行查询和分析：
- 查询所有过期订单
- 统计过期订单数量和金额
- 查询即将过期的订单
- 查看订单状态分布

### 6. 配置调整

#### 6.1 修改执行频率

在 `OrderScheduledTask.java` 中修改 Cron 表达式：

```java
// 每10分钟执行一次
@Scheduled(cron = "0 */10 * * * ?")

// 每小时执行一次
@Scheduled(cron = "0 0 * * * ?")

// 每天凌晨2点执行
@Scheduled(cron = "0 0 2 * * ?")
```

#### 6.2 Cron 表达式格式
```
秒 分 时 日 月 周
0  */5 *  *  *  ?   # 每5分钟
0  0   */2 *  *  ?   # 每2小时
0  0   0   *  *  ?   # 每天0点
```

### 7. 扩展功能建议

#### 7.1 添加通知功能
在订单即将过期时（如剩余5分钟），发送通知提醒用户：
- 短信通知
- 站内消息
- 推送通知

#### 7.2 添加订单恢复功能
允许用户在一定时间内恢复已取消的订单

#### 7.3 添加统计报表
定期生成过期订单统计报表：
- 过期订单数量趋势
- 过期订单金额统计
- 用户下单但未支付的行为分析

### 8. 注意事项

1. **事务处理**: 定时任务方法已添加 `@Transactional` 注解，确保数据一致性
2. **异常处理**: 单个订单处理失败不会影响其他订单的处理
3. **性能考虑**: 如果过期订单数量很大，建议分批处理
4. **数据备份**: 在删除订单前，建议定期备份数据库
5. **测试验证**: 在生产环境部署前，务必在测试环境充分测试

### 9. 测试方法

#### 9.1 创建测试订单
```java
// 创建一个1分钟后过期的订单用于测试
Date expireTime = new Date(now.getTime() + 1 * 60 * 1000);
paymentOrder.setExpireTime(expireTime);
```

#### 9.2 手动触发定时任务
在开发环境中，可以临时修改 Cron 表达式为更频繁的执行：
```java
@Scheduled(cron = "0 */1 * * * ?")  // 每1分钟执行一次
```

#### 9.3 验证结果
- 检查日志输出
- 查询数据库确认订单状态或是否被删除
- 验证相关业务逻辑是否正常

## 总结

本功能通过 Spring 的定时任务机制，实现了商品订单的自动过期处理。提供了两种处理策略（删除和取消），可根据业务需求灵活选择。配置简单，日志完善，便于监控和维护。
